--- 
title: "2D Gradient-enhanced Gaussian Process Regression"
author: "Pascal Pernot"
date: '`r Sys.Date()`'
output:
  html_document:
    highlight: tango
    number_sections: yes
    theme: cerulean
    toc: yes
---

```{r setup, include=FALSE}
rm(list = ls()); gc() # Clean environment

libs =c('rstan','knitr','DiceKriging')
for (lib in libs ) {
  if(!require(lib,character.only = TRUE))
    install.packages(lib,dependencies=TRUE)
 library(lib,character.only = TRUE)
}
rstan_options(auto_write = TRUE)

set.seed(1234) # Initialise la graine du RNG

# Couleurs transparente
blue_tr  = rgb(0.1,0.1,0.9,alpha=0.1) 

plot_predict2D <- function(data,fit,probs=c(0.025,0.5,0.975),cex=1) {
  # Plot prediction intervals 
  
  y_pred = extract(fit,"y2")[[1]]
  q_pred = matrix(NA,ncol=length(probs),nrow=length(data$x2))
  for (i in 1:length(data$x2)) {
    q_pred[i,] = quantile(y_pred[,i],probs=probs)
  }
  
  par(mar=c(3,3,1.6,.2),mgp=c(2,.75,0), 
      pty='s',tcl=-0.5, cex=cex)
  matplot(data$x2, data$x2, type='n',ylim=range(data$y1), 
          xlab='x', ylab='y')
  grid(); box()
  polygon(cbind(data$x2,rev(data$x2)),
          cbind(q_pred[,1],rev(q_pred[,3])),
          col=blue_tr, border=NA)
  lines(data$x2,q_pred[,2],lwd=2,col=4,lty=2)
  points(data$x1,data$y1,type='p',pch=19,col=2,cex=0.5)
  segments(data$x1,data$y1-2*data$uy1,data$x1,data$y1+2*data$uy1,
           lwd=2,col=2)
}
```


## Synthetic data

```{r robData, echo=FALSE, message=FALSE, warning=FALSE}

x1 = expand.grid(x1=seq(0,1,length=4), x2=seq(0,1,length=4))
n1 = nrow(x1)
y1 = apply(x1, 1, branin) 
uy1 = abs(y1 *0.05)

# Prediction grid
t1 = t2 = seq(0,1,length=10)
x2 = expand.grid(x1=t1, x2=t2)
y2_ref = apply(x2, 1, branin) 
n2 = nrow(x2)

# Plot data points and gradients
contour(t1, t2, matrix(y2_ref, 10, 10), 50, main="Branin")
points(x2[,1], x2[,2], pch=17, cex=1.5, col="blue")

# Save data
stan_rdump(c("N1", "x1","y1","uy1","dy1","udy1","N2","x2"), file="mydata.R")

```

## Standard GP

```{r GP}
mod = stan_model(file = 'GP2D.stan')

input_data <- read_rdump("mydata.R")
fit = sampling(mod, data = input_data,
               iter = 2000, chains = 1, warmup = 1000)

pars = c("eta_sq", "inv_rho_sq")
ab_summary <- summary(fit, pars = pars, 
                      probs = c(0.025, 0.975))$summary
knitr::kable(ab_summary[,c('mean','sd','2.5%','97.5%','n_eff','Rhat')],digits=3)

traceplot(fit,pars=pars,inc_warmup=TRUE)
pairs(fit,pars=pars)
```


## Gradient-Enhanced GP

```{r GEGP}
modGE = stan_model(file = 'GEGP0.stan')

input_data <- read_rdump("mydata.R")

fitGE = sampling(modGE, data = input_data,
                 iter = 2000, chains = 1, warmup = 1000)

pars = c("eta_sq", "inv_rho_sq")
ab_summary <- summary(fitGE, pars = pars, 
                      probs = c(0.025, 0.975))$summary
knitr::kable(ab_summary[,c('mean','sd','2.5%','97.5%','n_eff','Rhat')],digits=3)

traceplot(fitGE,pars=pars,inc_warmup=TRUE)
pairs(fitGE,pars=pars)

plot_predict(input_data,fitGE) 
lines(x2,eval(fmod,list(x=x2)),col=2,lty=3)
segments(x1-0.1,y1-0.1*dy1,x1+0.1,y1+0.1*dy1,lwd=2,col=3)
title(main='Gradient-enhanced GP')
```


## Comparison

```{r compare, echo=FALSE, message=FALSE, warning=FALSE}
par(mfrow = c(1,2))

plot_predict(input_data,fit)
lines(x2,eval(fmod,list(x=x2)),col=2,lty=3)
title(main='Standard GP')

plot_predict(input_data,fitGE) 
lines(x2,eval(fmod,list(x=x2)),col=2,lty=3)
segments(x1-0.1,y1-0.1*dy1,x1+0.1,y1+0.1*dy1,lwd=2,col=3)
title(main='Gradient-enhanced GP')

```
